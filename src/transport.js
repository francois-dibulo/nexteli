// https://transport.opendata.ch/docs.html
const OPENDATA_BASE_URL = 'https://transport.opendata.ch/v1/';

function findStationsCandidates(query) {
	var url = `${OPENDATA_BASE_URL}locations?query=${query}&type=station`;

	// const stubOerlikon = {"stations":[{"id":"8503006","name":"Z\u00fcrich Oerlikon","score":null,"coordinate":{"type":"WGS84","x":47.411526,"y":8.54414},"distance":null,"icon":"train"},{"id":"8591382","name":"Z\u00fcrich, Sternen Oerlikon","score":null,"coordinate":{"type":"WGS84","x":47.410067,"y":8.54623},"distance":null,"icon":"tram"},{"id":"8591063","name":"Z\u00fcrich Oerlikon, Bahnhof Ost","score":null,"coordinate":{"type":"WGS84","x":47.413335,"y":8.545847},"distance":null,"icon":"tram"},{"id":"8580449","name":"Z\u00fcrich Oerlikon, Bahnhof","score":null,"coordinate":{"type":"WGS84","x":47.411493,"y":8.544789},"distance":null,"icon":"tram"},{"id":"8591062","name":"Z\u00fcrich Oerlikon, Bahnhof Nord","score":null,"coordinate":{"type":"WGS84","x":47.412186,"y":8.543783},"distance":null,"icon":"bus"},{"id":"8591175","name":"Z\u00fcrich, Hallenbad Oerlikon","score":null,"coordinate":{"type":"WGS84","x":47.410702,"y":8.555863},"distance":null,"icon":"bus"},{"id":null,"name":"Z\u00fcrich, Oerlikon ","score":null,"coordinate":{"type":"WGS84","x":null,"y":null},"distance":null,"icon":null},{"id":null,"name":"Z\u00fcrich, Oerlikonerstr. ","score":null,"coordinate":{"type":"WGS84","x":null,"y":null},"distance":null,"icon":null},{"id":null,"name":"Z\u00fcrich, Oerlikonerstr. 3 ","score":null,"coordinate":{"type":"WGS84","x":null,"y":null},"distance":null,"icon":null},{"id":null,"name":"Z\u00fcrich, Oerlikonerstr. 5 ","score":null,"coordinate":{"type":"WGS84","x":null,"y":null},"distance":null,"icon":null}]};
	// const stubHb = {"stations":[{"id":"8503000","name":"Z\u00fcrich HB","score":null,"coordinate":{"type":"WGS84","x":47.377847,"y":8.540502},"distance":null,"icon":"train"},{"id":"8587349","name":"Z\u00fcrich, Bahnhofquai\/HB","score":null,"coordinate":{"type":"WGS84","x":47.377556,"y":8.541741},"distance":null,"icon":"tram"},{"id":"8591067","name":"Z\u00fcrich, Bahnhofstrasse\/HB","score":null,"coordinate":{"type":"WGS84","x":47.37622,"y":8.539462},"distance":null,"icon":"tram"},{"id":"8503088","name":"Z\u00fcrich HB SZU","score":null,"coordinate":{"type":"WGS84","x":47.377637,"y":8.538909},"distance":null,"icon":null},{"id":"8587348","name":"Z\u00fcrich, Bahnhofplatz\/HB","score":null,"coordinate":{"type":"WGS84","x":47.377237,"y":8.539337},"distance":null,"icon":"tram"},{"id":"8591368","name":"Z\u00fcrich, Sihlquai\/HB","score":null,"coordinate":{"type":"WGS84","x":47.379871,"y":8.537604},"distance":null,"icon":"tram"},{"id":"8591367","name":"Z\u00fcrich, Sihlpost\/HB","score":null,"coordinate":{"type":"WGS84","x":47.37609,"y":8.534202},"distance":null,"icon":"tram"},{"id":null,"name":"Z\u00fcrich, HB ","score":null,"coordinate":{"type":"WGS84","x":null,"y":null},"distance":null,"icon":null},{"id":null,"name":"Z\u00fcrich, HB Plaza ","score":null,"coordinate":{"type":"WGS84","x":null,"y":null},"distance":null,"icon":null},{"id":null,"name":"Zahnarzt Z\u00fcrich HB ShopVille | Notfall Zahnarzt | swiss smile, Z\u00fcrich, Museumstr. 1","score":null,"coordinate":{"type":"WGS84","x":null,"y":null},"distance":null,"icon":null}]};
	// const stubLinden = {"stations":[{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null,"icon":"tram"},{"id":"8572387","name":"Baden, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.471145,"y":8.305431},"distance":null,"icon":"bus"},{"id":"8590575","name":"D\u00fcbendorf, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.398503,"y":8.620297},"distance":null,"icon":"bus"},{"id":"8589287","name":"Allschwil, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.557664,"y":7.560417},"distance":null,"icon":"tram"},{"id":"8573674","name":"Winterthur, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.510585,"y":8.693548},"distance":null,"icon":"bus"},{"id":"8502888","name":"Mellingen, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.418188,"y":8.27193},"distance":null,"icon":"bus"},{"id":"8590913","name":"Weiningen ZH, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.419552,"y":8.433937},"distance":null,"icon":"bus"},{"id":"8590892","name":"Wallisellen, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.419907,"y":8.598493},"distance":null,"icon":"bus"},{"id":"8574076","name":"Heiden, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.447036,"y":9.529951},"distance":null,"icon":"bus"},{"id":"8578699","name":"Staufen, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.383944,"y":8.168414},"distance":null,"icon":"bus"}]};
	// const stubStauffacher = {"stations":[{"id":"8591381","name":"Z\u00fcrich, Stauffacher","score":null,"coordinate":{"type":"WGS84","x":47.37342,"y":8.529248},"distance":null,"icon":"tram"},{"id":"8578571","name":"Walenstadtberg, Stauffacher","score":null,"coordinate":{"type":"WGS84","x":47.136131,"y":9.296176},"distance":null,"icon":"bus"},{"id":"8576988","name":"Bern, Stauffacherbr\u00fccke","score":null,"coordinate":{"type":"WGS84","x":46.966129,"y":7.455456},"distance":null,"icon":"bus"},{"id":null,"name":"Bern, Stauffacherstr. ","score":null,"coordinate":{"type":"WGS84","x":null,"y":null},"distance":null,"icon":null},{"id":null,"name":"Z\u00fcrich, Stauffacherstr. ","score":null,"coordinate":{"type":"WGS84","x":null,"y":null},"distance":null,"icon":null},{"id":null,"name":"Schaffhausen, Stauffacherstr. ","score":null,"coordinate":{"type":"WGS84","x":null,"y":null},"distance":null,"icon":null},{"id":null,"name":"B\u00e4tterkinden, Stauffacherstr. ","score":null,"coordinate":{"type":"WGS84","x":null,"y":null},"distance":null,"icon":null},{"id":null,"name":"Z\u00fcrich, Stauffacherquai ","score":null,"coordinate":{"type":"WGS84","x":null,"y":null},"distance":null,"icon":null},{"id":null,"name":"Luzern, Stauffacherweg ","score":null,"coordinate":{"type":"WGS84","x":null,"y":null},"distance":null,"icon":null},{"id":null,"name":"St. Gallen, Stauffacherstr. ","score":null,"coordinate":{"type":"WGS84","x":null,"y":null},"distance":null,"icon":null}]};

	var filterCandidates = function(candidates) {
		return candidates.stations.filter((c) => c.id);
	};

	//return Promise.resolve(filterCandidates(query === "Lindenplatz" ? stubLinden : stubStauffacher));
	return fetch(url)
		.then((r) => r.json())
		.then((r) => filterCandidates(r));
}


function findNextDeparture(itinerary) {
	var url = `${OPENDATA_BASE_URL}connections?from=${itinerary.departure.id}&to=${itinerary.destination.id}`;

	const stub = {"connections":[{"from":{"station":{"id":"8591222","name":"Z\u00fcrich, Kappeli","score":null,"coordinate":{"type":"WGS84","x":47.384987,"y":8.495394},"distance":null},"arrival":null,"arrivalTimestamp":null,"departure":"2022-11-06T20:52:00+0100","departureTimestamp":1667764320,"delay":0,"platform":null,"prognosis":{"platform":null,"arrival":null,"departure":"2022-11-06T20:52:00+0100","capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591222","name":"Z\u00fcrich, Kappeli","score":null,"coordinate":{"type":"WGS84","x":47.384987,"y":8.495394},"distance":null}},"to":{"station":{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null},"arrival":"2022-11-06T20:54:00+0100","arrivalTimestamp":1667764440,"departure":null,"departureTimestamp":null,"delay":null,"platform":null,"prognosis":{"platform":null,"arrival":null,"departure":null,"capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null}},"duration":"00d00:02:00","transfers":0,"service":null,"products":["2"],"capacity1st":null,"capacity2nd":null,"sections":[{"journey":{"name":"031330","category":"T","subcategory":null,"categoryCode":null,"number":"2","operator":"VBZ    F","to":"Schlieren, Geissweid","passList":[{"station":{"id":"8591222","name":"Z\u00fcrich, Kappeli","score":null,"coordinate":{"type":"WGS84","x":47.384987,"y":8.495394},"distance":null},"arrival":null,"arrivalTimestamp":null,"departure":"2022-11-06T20:52:00+0100","departureTimestamp":1667764320,"delay":0,"platform":null,"prognosis":{"platform":null,"arrival":null,"departure":"2022-11-06T20:52:00+0100","capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591222","name":"Z\u00fcrich, Kappeli","score":null,"coordinate":{"type":"WGS84","x":47.384987,"y":8.495394},"distance":null}},{"station":{"id":"8591165","name":"Z\u00fcrich, Grimselstrasse","score":null,"coordinate":{"type":"WGS84","x":47.386961,"y":8.490082},"distance":null},"arrival":"2022-11-06T20:53:00+0100","arrivalTimestamp":1667764380,"departure":"2022-11-06T20:53:00+0100","departureTimestamp":1667764380,"delay":0,"platform":null,"prognosis":{"platform":null,"arrival":null,"departure":"2022-11-06T20:53:00+0100","capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591165","name":"Z\u00fcrich, Grimselstrasse","score":null,"coordinate":{"type":"WGS84","x":47.386961,"y":8.490082},"distance":null}},{"station":{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null},"arrival":"2022-11-06T20:54:00+0100","arrivalTimestamp":1667764440,"departure":null,"departureTimestamp":null,"delay":0,"platform":null,"prognosis":{"platform":null,"arrival":"2022-11-06T20:54:00+0100","departure":null,"capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null}}],"capacity1st":null,"capacity2nd":null},"walk":null,"departure":{"station":{"id":"8591222","name":"Z\u00fcrich, Kappeli","score":null,"coordinate":{"type":"WGS84","x":47.384987,"y":8.495394},"distance":null},"arrival":null,"arrivalTimestamp":null,"departure":"2022-11-06T20:52:00+0100","departureTimestamp":1667764320,"delay":0,"platform":null,"prognosis":{"platform":null,"arrival":null,"departure":"2022-11-06T20:52:00+0100","capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591222","name":"Z\u00fcrich, Kappeli","score":null,"coordinate":{"type":"WGS84","x":47.384987,"y":8.495394},"distance":null}},"arrival":{"station":{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null},"arrival":"2022-11-06T20:54:00+0100","arrivalTimestamp":1667764440,"departure":null,"departureTimestamp":null,"delay":0,"platform":null,"prognosis":{"platform":null,"arrival":"2022-11-06T20:54:00+0100","departure":null,"capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null}}}]},{"from":{"station":{"id":"8591222","name":"Z\u00fcrich, Kappeli","score":null,"coordinate":{"type":"WGS84","x":47.384987,"y":8.495394},"distance":null},"arrival":null,"arrivalTimestamp":null,"departure":"2022-11-06T21:02:00+0100","departureTimestamp":1667764920,"delay":0,"platform":null,"prognosis":{"platform":null,"arrival":null,"departure":"2022-11-06T21:02:00+0100","capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591222","name":"Z\u00fcrich, Kappeli","score":null,"coordinate":{"type":"WGS84","x":47.384987,"y":8.495394},"distance":null}},"to":{"station":{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null},"arrival":"2022-11-06T21:04:00+0100","arrivalTimestamp":1667765040,"departure":null,"departureTimestamp":null,"delay":null,"platform":null,"prognosis":{"platform":null,"arrival":null,"departure":null,"capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null}},"duration":"00d00:02:00","transfers":0,"service":null,"products":["2"],"capacity1st":null,"capacity2nd":null,"sections":[{"journey":{"name":"031676","category":"T","subcategory":null,"categoryCode":null,"number":"2","operator":"VBZ    F","to":"Schlieren, Geissweid","passList":[{"station":{"id":"8591222","name":"Z\u00fcrich, Kappeli","score":null,"coordinate":{"type":"WGS84","x":47.384987,"y":8.495394},"distance":null},"arrival":null,"arrivalTimestamp":null,"departure":"2022-11-06T21:02:00+0100","departureTimestamp":1667764920,"delay":0,"platform":null,"prognosis":{"platform":null,"arrival":null,"departure":"2022-11-06T21:02:00+0100","capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591222","name":"Z\u00fcrich, Kappeli","score":null,"coordinate":{"type":"WGS84","x":47.384987,"y":8.495394},"distance":null}},{"station":{"id":"8591165","name":"Z\u00fcrich, Grimselstrasse","score":null,"coordinate":{"type":"WGS84","x":47.386961,"y":8.490082},"distance":null},"arrival":"2022-11-06T21:03:00+0100","arrivalTimestamp":1667764980,"departure":"2022-11-06T21:03:00+0100","departureTimestamp":1667764980,"delay":0,"platform":null,"prognosis":{"platform":null,"arrival":null,"departure":"2022-11-06T21:03:00+0100","capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591165","name":"Z\u00fcrich, Grimselstrasse","score":null,"coordinate":{"type":"WGS84","x":47.386961,"y":8.490082},"distance":null}},{"station":{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null},"arrival":"2022-11-06T21:04:00+0100","arrivalTimestamp":1667765040,"departure":null,"departureTimestamp":null,"delay":0,"platform":null,"prognosis":{"platform":null,"arrival":"2022-11-06T21:04:00+0100","departure":null,"capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null}}],"capacity1st":null,"capacity2nd":null},"walk":null,"departure":{"station":{"id":"8591222","name":"Z\u00fcrich, Kappeli","score":null,"coordinate":{"type":"WGS84","x":47.384987,"y":8.495394},"distance":null},"arrival":null,"arrivalTimestamp":null,"departure":"2022-11-06T21:02:00+0100","departureTimestamp":1667764920,"delay":0,"platform":null,"prognosis":{"platform":null,"arrival":null,"departure":"2022-11-06T21:02:00+0100","capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591222","name":"Z\u00fcrich, Kappeli","score":null,"coordinate":{"type":"WGS84","x":47.384987,"y":8.495394},"distance":null}},"arrival":{"station":{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null},"arrival":"2022-11-06T21:04:00+0100","arrivalTimestamp":1667765040,"departure":null,"departureTimestamp":null,"delay":0,"platform":null,"prognosis":{"platform":null,"arrival":"2022-11-06T21:04:00+0100","departure":null,"capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null}}}]},{"from":{"station":{"id":"8591222","name":"Z\u00fcrich, Kappeli","score":null,"coordinate":{"type":"WGS84","x":47.384987,"y":8.495394},"distance":null},"arrival":null,"arrivalTimestamp":null,"departure":"2022-11-06T21:12:00+0100","departureTimestamp":1667765520,"delay":0,"platform":null,"prognosis":{"platform":null,"arrival":null,"departure":"2022-11-06T21:12:00+0100","capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591222","name":"Z\u00fcrich, Kappeli","score":null,"coordinate":{"type":"WGS84","x":47.384987,"y":8.495394},"distance":null}},"to":{"station":{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null},"arrival":"2022-11-06T21:14:00+0100","arrivalTimestamp":1667765640,"departure":null,"departureTimestamp":null,"delay":null,"platform":null,"prognosis":{"platform":null,"arrival":null,"departure":null,"capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null}},"duration":"00d00:02:00","transfers":0,"service":null,"products":["2"],"capacity1st":null,"capacity2nd":null,"sections":[{"journey":{"name":"031990","category":"T","subcategory":null,"categoryCode":null,"number":"2","operator":"VBZ    F","to":"Schlieren, Geissweid","passList":[{"station":{"id":"8591222","name":"Z\u00fcrich, Kappeli","score":null,"coordinate":{"type":"WGS84","x":47.384987,"y":8.495394},"distance":null},"arrival":null,"arrivalTimestamp":null,"departure":"2022-11-06T21:12:00+0100","departureTimestamp":1667765520,"delay":0,"platform":null,"prognosis":{"platform":null,"arrival":null,"departure":"2022-11-06T21:12:00+0100","capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591222","name":"Z\u00fcrich, Kappeli","score":null,"coordinate":{"type":"WGS84","x":47.384987,"y":8.495394},"distance":null}},{"station":{"id":"8591165","name":"Z\u00fcrich, Grimselstrasse","score":null,"coordinate":{"type":"WGS84","x":47.386961,"y":8.490082},"distance":null},"arrival":"2022-11-06T21:13:00+0100","arrivalTimestamp":1667765580,"departure":"2022-11-06T21:13:00+0100","departureTimestamp":1667765580,"delay":0,"platform":null,"prognosis":{"platform":null,"arrival":null,"departure":"2022-11-06T21:13:00+0100","capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591165","name":"Z\u00fcrich, Grimselstrasse","score":null,"coordinate":{"type":"WGS84","x":47.386961,"y":8.490082},"distance":null}},{"station":{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null},"arrival":"2022-11-06T21:14:00+0100","arrivalTimestamp":1667765640,"departure":null,"departureTimestamp":null,"delay":0,"platform":null,"prognosis":{"platform":null,"arrival":"2022-11-06T21:14:00+0100","departure":null,"capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null}}],"capacity1st":null,"capacity2nd":null},"walk":null,"departure":{"station":{"id":"8591222","name":"Z\u00fcrich, Kappeli","score":null,"coordinate":{"type":"WGS84","x":47.384987,"y":8.495394},"distance":null},"arrival":null,"arrivalTimestamp":null,"departure":"2022-11-06T21:12:00+0100","departureTimestamp":1667765520,"delay":0,"platform":null,"prognosis":{"platform":null,"arrival":null,"departure":"2022-11-06T21:12:00+0100","capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591222","name":"Z\u00fcrich, Kappeli","score":null,"coordinate":{"type":"WGS84","x":47.384987,"y":8.495394},"distance":null}},"arrival":{"station":{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null},"arrival":"2022-11-06T21:14:00+0100","arrivalTimestamp":1667765640,"departure":null,"departureTimestamp":null,"delay":0,"platform":null,"prognosis":{"platform":null,"arrival":"2022-11-06T21:14:00+0100","departure":null,"capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null}}}]},{"from":{"station":{"id":"8591222","name":"Z\u00fcrich, Kappeli","score":null,"coordinate":{"type":"WGS84","x":47.384987,"y":8.495394},"distance":null},"arrival":null,"arrivalTimestamp":null,"departure":"2022-11-06T21:22:00+0100","departureTimestamp":1667766120,"delay":0,"platform":null,"prognosis":{"platform":null,"arrival":null,"departure":"2022-11-06T21:22:00+0100","capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591222","name":"Z\u00fcrich, Kappeli","score":null,"coordinate":{"type":"WGS84","x":47.384987,"y":8.495394},"distance":null}},"to":{"station":{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null},"arrival":"2022-11-06T21:24:00+0100","arrivalTimestamp":1667766240,"departure":null,"departureTimestamp":null,"delay":null,"platform":null,"prognosis":{"platform":null,"arrival":null,"departure":null,"capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null}},"duration":"00d00:02:00","transfers":0,"service":null,"products":["2"],"capacity1st":null,"capacity2nd":null,"sections":[{"journey":{"name":"032290","category":"T","subcategory":null,"categoryCode":null,"number":"2","operator":"VBZ    F","to":"Schlieren, Geissweid","passList":[{"station":{"id":"8591222","name":"Z\u00fcrich, Kappeli","score":null,"coordinate":{"type":"WGS84","x":47.384987,"y":8.495394},"distance":null},"arrival":null,"arrivalTimestamp":null,"departure":"2022-11-06T21:22:00+0100","departureTimestamp":1667766120,"delay":0,"platform":null,"prognosis":{"platform":null,"arrival":null,"departure":"2022-11-06T21:22:00+0100","capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591222","name":"Z\u00fcrich, Kappeli","score":null,"coordinate":{"type":"WGS84","x":47.384987,"y":8.495394},"distance":null}},{"station":{"id":"8591165","name":"Z\u00fcrich, Grimselstrasse","score":null,"coordinate":{"type":"WGS84","x":47.386961,"y":8.490082},"distance":null},"arrival":"2022-11-06T21:23:00+0100","arrivalTimestamp":1667766180,"departure":"2022-11-06T21:23:00+0100","departureTimestamp":1667766180,"delay":0,"platform":null,"prognosis":{"platform":null,"arrival":null,"departure":"2022-11-06T21:23:00+0100","capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591165","name":"Z\u00fcrich, Grimselstrasse","score":null,"coordinate":{"type":"WGS84","x":47.386961,"y":8.490082},"distance":null}},{"station":{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null},"arrival":"2022-11-06T21:24:00+0100","arrivalTimestamp":1667766240,"departure":null,"departureTimestamp":null,"delay":0,"platform":null,"prognosis":{"platform":null,"arrival":"2022-11-06T21:24:00+0100","departure":null,"capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null}}],"capacity1st":null,"capacity2nd":null},"walk":null,"departure":{"station":{"id":"8591222","name":"Z\u00fcrich, Kappeli","score":null,"coordinate":{"type":"WGS84","x":47.384987,"y":8.495394},"distance":null},"arrival":null,"arrivalTimestamp":null,"departure":"2022-11-06T21:22:00+0100","departureTimestamp":1667766120,"delay":0,"platform":null,"prognosis":{"platform":null,"arrival":null,"departure":"2022-11-06T21:22:00+0100","capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591222","name":"Z\u00fcrich, Kappeli","score":null,"coordinate":{"type":"WGS84","x":47.384987,"y":8.495394},"distance":null}},"arrival":{"station":{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null},"arrival":"2022-11-06T21:24:00+0100","arrivalTimestamp":1667766240,"departure":null,"departureTimestamp":null,"delay":0,"platform":null,"prognosis":{"platform":null,"arrival":"2022-11-06T21:24:00+0100","departure":null,"capacity1st":null,"capacity2nd":null},"realtimeAvailability":null,"location":{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null}}}]}],"from":{"id":"8591222","name":"Z\u00fcrich, Kappeli","score":null,"coordinate":{"type":"WGS84","x":47.384987,"y":8.495394},"distance":null},"to":{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null},"stations":{"from":[{"id":"8591222","name":"Z\u00fcrich, Kappeli","score":null,"coordinate":{"type":"WGS84","x":47.384987,"y":8.495394},"distance":null}],"to":[{"id":"8591258","name":"Z\u00fcrich, Lindenplatz","score":null,"coordinate":{"type":"WGS84","x":47.387815,"y":8.486112},"distance":null}]}}

	var formatConnections = function(connections) {
		var result = [];
		var now = 1667763999042;
		now = Date.now();
		console.log("formatConnections", connections);
		
		for (var i = 0; i < connections.length; i++) {
			let connection = connections[i];

			var departureTimestamp = connection.from.departureTimestamp * 1000;
			var delta = departureTimestamp - now;
			var data = {
				// Duration in seconds
				duration: connection.to.arrivalTimestamp - connection.from.departureTimestamp,
				transfers: connection.transfers,
				line: connection.products.join(","), // ['S2']
				departure: {
					date: connection.from.departure,
					ts: departureTimestamp,
					platform: connection.from.platform, // "4"
				},
				arrival: {
					ts: connection.to.arrivalTimestamp * 1000,
					date: connection.to.arrival,
					platform: connection.to.platform,
				},
				delta: delta,
				delta_str: getMinutesHuman(Math.round(delta / 1000))
			};
			result.push(data);
		}

		result = result.sort(function(a, b) {
			return a.departure.ts - b.departure.ts;
		});

		return result;
	};

	//return Promise.resolve(formatConnections(stub.connections));

	return fetch(url)
		.then((r) => r.json())
		.then((r) => formatConnections(r.connections));
}

function getNextConnection(connections) {
	const now = Date.now();
	var next = null;

	for (var i = 0; i < connections.length; i++) {
		var con = connections[i];

		if (now < con.departure.ts) {
			next = con;
			var delta = con.departure.ts - now;
			next.delta = delta;
			next.delta_str = getMinutesHuman(Math.round(delta / 1000));
			break;
		}
	}

	return next;
}
